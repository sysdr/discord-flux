<svg viewBox="0 0 900 700" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .lifeline { stroke: #95a5a6; stroke-width: 2; stroke-dasharray: 5,5; }
      .box { fill: white; stroke: #2c3e50; stroke-width: 2; }
      .actor { fill: #3498db; stroke: #2c3e50; stroke-width: 2; }
      .title { font-family: Arial; font-size: 14px; font-weight: bold; fill: #2c3e50; }
      .text { font-family: Arial; font-size: 11px; fill: #34495e; }
      .arrow { stroke: #e74c3c; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .return { stroke: #27ae60; stroke-width: 2; fill: none; stroke-dasharray: 5,5; marker-end: url(#arrowhead2); }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#e74c3c" />
    </marker>
    <marker id="arrowhead2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#27ae60" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" class="title" font-size="18">Pagination Sequence Flow</text>
  
  <!-- Actors -->
  <rect x="50" y="60" width="100" height="40" class="actor"/>
  <text x="100" y="85" text-anchor="middle" class="title" fill="white">Client</text>
  
  <rect x="250" y="60" width="120" height="40" class="actor"/>
  <text x="310" y="85" text-anchor="middle" class="title" fill="white">HttpServer</text>
  
  <rect x="470" y="60" width="140" height="40" class="actor"/>
  <text x="540" y="85" text-anchor="middle" class="title" fill="white">PaginationService</text>
  
  <rect x="710" y="60" width="120" height="40" class="actor"/>
  <text x="770" y="85" text-anchor="middle" class="title" fill="white">Cassandra</text>
  
  <!-- Lifelines -->
  <line x1="100" y1="100" x2="100" y2="650" class="lifeline"/>
  <line x1="310" y1="100" x2="310" y2="650" class="lifeline"/>
  <line x1="540" y1="100" x2="540" y2="650" class="lifeline"/>
  <line x1="770" y1="100" x2="770" y2="650" class="lifeline"/>
  
  <!-- Sequence Steps -->
  
  <!-- Step 1 -->
  <path d="M 100 130 L 310 130" class="arrow"/>
  <text x="205" y="125" text-anchor="middle" class="text">GET /messages?cursor=ABC</text>
  
  <!-- Step 2 -->
  <rect x="300" y="140" width="20" height="30" fill="#ecf0f1" stroke="#2c3e50"/>
  <text x="250" y="160" text-anchor="end" class="text">Parse query params</text>
  
  <!-- Step 3 -->
  <path d="M 310 180 L 540 180" class="arrow"/>
  <text x="425" y="175" text-anchor="middle" class="text">fetchPage(channelId, cursor, limit)</text>
  
  <!-- Step 4 -->
  <rect x="530" y="190" width="20" height="40" fill="#ecf0f1" stroke="#2c3e50"/>
  <text x="480" y="215" text-anchor="end" class="text">Decode cursor</text>
  <text x="480" y="228" text-anchor="end" class="text">Extract message_id</text>
  
  <!-- Step 5 -->
  <path d="M 540 240 L 770 240" class="arrow"/>
  <text x="655" y="235" text-anchor="middle" class="text">SELECT * WHERE channel_id=?</text>
  <text x="655" y="248" text-anchor="middle" class="text">AND message_id < ? LIMIT ?</text>
  
  <!-- Step 6 -->
  <rect x="760" y="260" width="20" height="50" fill="#ecf0f1" stroke="#2c3e50"/>
  <text x="710" y="280" text-anchor="end" class="text">Seek to clustering key</text>
  <text x="710" y="293" text-anchor="end" class="text">Read 51 rows</text>
  <text x="710" y="306" text-anchor="end" class="text">(limit + 1 for hasMore)</text>
  
  <!-- Step 7 -->
  <path d="M 770 320 L 540 320" class="return"/>
  <text x="655" y="315" text-anchor="middle" class="text">ResultSet (Iterator)</text>
  
  <!-- Step 8 -->
  <rect x="530" y="330" width="20" height="80" fill="#ecf0f1" stroke="#2c3e50"/>
  <text x="480" y="350" text-anchor="end" class="text">while (iterator.hasNext())</text>
  <text x="480" y="365" text-anchor="end" class="text">  row = iterator.next()</text>
  <text x="480" y="380" text-anchor="end" class="text">  messages.add(row)</text>
  <text x="480" y="395" text-anchor="end" class="text">hasMore = iterator.hasNext()</text>
  <text x="480" y="408" text-anchor="end" class="text">Encode next cursor</text>
  
  <!-- Step 9 -->
  <path d="M 540 420 L 310 420" class="return"/>
  <text x="425" y="415" text-anchor="middle" class="text">PageResult(messages, nextCursor, hasMore)</text>
  
  <!-- Step 10 -->
  <rect x="300" y="430" width="20" height="40" fill="#ecf0f1" stroke="#2c3e50"/>
  <text x="250" y="450" text-anchor="end" class="text">Serialize to JSON</text>
  <text x="250" y="463" text-anchor="end" class="text">Set Content-Type</text>
  
  <!-- Step 11 -->
  <path d="M 310 480 L 100 480" class="return"/>
  <text x="205" y="475" text-anchor="middle" class="text">HTTP 200 + JSON body</text>
  
  <!-- Step 12 - Client updates UI -->
  <rect x="90" y="490" width="20" height="40" fill="#ecf0f1" stroke="#2c3e50"/>
  <text x="40" y="510" text-anchor="end" class="text">Update UI</text>
  <text x="40" y="523" text-anchor="end" class="text">Store cursor</text>
  
  <!-- Notes -->
  <rect x="50" y="560" width="800" height="80" fill="#fff9e6" stroke="#f39c12" stroke-width="2"/>
  <text x="60" y="580" class="title">Performance Optimizations:</text>
  <text x="60" y="598" class="text">1. PreparedStatements prevent query parsing on each request</text>
  <text x="60" y="612" class="text">2. Iterator streaming prevents materializing full result set (no .all() call)</text>
  <text x="60" y="626" class="text">3. Limit+1 trick detects "has more" without separate COUNT query</text>
</svg>
